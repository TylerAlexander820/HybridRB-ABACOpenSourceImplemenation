{
  "ruleChain": {
    "name": "Smart Home Rule Chain",
    "type": "EDGE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null,
    "additionalInfo": {
      "description": ""
    }
  },
  "metadata": {
    "version": 98,
    "firstNodeIndex": 8,
    "nodes": [
      {
        "type": "org.thingsboard.rule.engine.rest.TbRestApiCallNode",
        "name": "Keycloak Rule Authentication",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 3,
        "configuration": {
          "restEndpointUrlPattern": "http://host.docker.internal:8081/realms/Thingsboard/protocol/openid-connect/token",
          "requestMethod": "POST",
          "useSimpleClientHttpFactory": false,
          "parseToPlainText": true,
          "ignoreRequestBody": false,
          "enableProxy": false,
          "useSystemProxyProperties": false,
          "proxyScheme": null,
          "proxyHost": null,
          "proxyPort": 0,
          "proxyUser": null,
          "proxyPassword": null,
          "readTimeoutMs": 0,
          "maxParallelRequestsCount": 0,
          "headers": {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          "credentials": {
            "type": "anonymous"
          },
          "maxInMemoryBufferSizeInKb": 256
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1558,
          "layoutY": 361
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Keycloak Admin Transformation",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1764707986089
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "metadata.originalData = JSON.stringify({\n    userEmail: metadata.userEmail,\n    method: msg.method,\n    value: msg.params\n});\n\nvar keycloakBody = \"client_id=thingsboard&client_secret=R8drKfEVkOD8xbVMjbNhRFbGaKPO2QVU&grant_type=client_credentials\";\n\nreturn { msg: keycloakBody, metadata: metadata, msgType: \"POST_TELEMETRY_REQUEST\" };",
          "tbelScript": "return {msg: msg, metadata: metadata, msgType: msgType};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1288,
          "layoutY": 359
        }
      },
      {
        "type": "org.thingsboard.rule.engine.rest.TbRestApiCallNode",
        "name": "Keycloak GET User Data",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 3,
        "configuration": {
          "restEndpointUrlPattern": "http://host.docker.internal:8081/admin/realms/Thingsboard/users?search=${shared_userEmail}",
          "requestMethod": "GET",
          "useSimpleClientHttpFactory": false,
          "parseToPlainText": false,
          "ignoreRequestBody": false,
          "enableProxy": false,
          "useSystemProxyProperties": false,
          "proxyScheme": null,
          "proxyHost": null,
          "proxyPort": 0,
          "proxyUser": null,
          "proxyPassword": null,
          "readTimeoutMs": 0,
          "maxParallelRequestsCount": 0,
          "headers": {
            "Content-Type": "application/json",
            "Authorization": "Bearer $[access_token]"
          },
          "credentials": {
            "type": "anonymous"
          },
          "maxInMemoryBufferSizeInKb": 256
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1819,
          "layoutY": 367
        }
      },
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "Save to DB",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "defaultTTL": 0,
          "useServerTs": false,
          "processingSettings": {
            "type": "ON_EVERY_MESSAGE"
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 2252,
          "layoutY": 597
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Keycloak TO JSON Transformation",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1764579357891
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "var accessToken = msg.access_token;\nmetadata.accessToken = accessToken;\n\nreturn { msg: msg, metadata: metadata };",
          "tbelScript": "return {msg: msg, metadata: metadata, msgType: msgType};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1727,
          "layoutY": 212
        }
      },
      {
        "type": "org.thingsboard.rule.engine.rest.TbRestApiCallNode",
        "name": "Keycloak GET User Roles",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1764853469412
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 3,
        "configuration": {
          "restEndpointUrlPattern": "http://host.docker.internal:8081/admin/realms/Thingsboard/users/${userId}/role-mappings/realm",
          "requestMethod": "GET",
          "useSimpleClientHttpFactory": false,
          "parseToPlainText": false,
          "ignoreRequestBody": false,
          "enableProxy": false,
          "useSystemProxyProperties": false,
          "proxyScheme": null,
          "proxyHost": null,
          "proxyPort": 0,
          "proxyUser": null,
          "proxyPassword": null,
          "readTimeoutMs": 0,
          "maxParallelRequestsCount": 0,
          "headers": {
            "Content-Type": "application/json",
            "Authorization": "Bearer ${accessToken}"
          },
          "credentials": {
            "type": "anonymous"
          },
          "maxInMemoryBufferSizeInKb": 256
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 2069,
          "layoutY": 373
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Keycloak Parse User ID",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1764579357891
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "// msg is the array from GET /users\nvar user = (msg && msg.length > 0) ? msg[0] : null;\nmetadata.userId = user ? user.id : null;\n\nreturn { msg: msg, metadata: metadata };",
          "tbelScript": ""
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1984,
          "layoutY": 214
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Keycloak Parse Client ID",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1764579357891
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "var roles = msg;\nvar validRoles = [\"shParent\", \"shChild\", \"shTeen\"]\nvar role = null;\n\nfor (var i = 0; i < roles.length; i++) {\n    if (validRoles.indexOf(roles[i].name) !== -1) {\n        role = roles[i];\n        break;\n    }\n}\n\nif (role === null) {\n    return {\n        msg: { error: \"Role not found\" },\n        metadata: metadata\n    };\n}\n\nmetadata.roleId = role.id;\nmetadata.roleName = role.name;\n\nreturn { msg: msg, metadata: metadata };",
          "tbelScript": ""
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 2209,
          "layoutY": 219
        }
      },
      {
        "type": "org.thingsboard.rule.engine.filter.TbMsgTypeSwitchNode",
        "name": "Message Type Switch",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1764579215802
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "version": 0
        },
        "additionalInfo": {
          "description": null,
          "layoutX": 356,
          "layoutY": 223
        }
      },
      {
        "type": "org.thingsboard.rule.engine.metadata.TbGetAttributesNode",
        "name": "Check ParentApproval/OvenState Attributes",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "tellFailureIfAbsent": true,
          "fetchTo": "METADATA",
          "clientAttributeNames": [],
          "sharedAttributeNames": [
            "parentApproval",
            "ovenState"
          ],
          "serverAttributeNames": [],
          "latestTsKeyNames": [],
          "getLatestValueWithTs": true
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 995,
          "layoutY": 112
        }
      },
      {
        "type": "org.thingsboard.rule.engine.metadata.TbGetAttributesNode",
        "name": "Get Current User",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1764830917372
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "tellFailureIfAbsent": true,
          "fetchTo": "METADATA",
          "clientAttributeNames": [],
          "sharedAttributeNames": [
            "userEmail"
          ],
          "serverAttributeNames": [],
          "latestTsKeyNames": [],
          "getLatestValueWithTs": true
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 998,
          "layoutY": 358
        }
      },
      {
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Smart Oven Check",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1764405994175
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "if (metadata.deviceName === \"smartOven\"){\n    return true;\n} else {\n    return false;\n}",
          "tbelScript": "return msg.temperature > 20;"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 627,
          "layoutY": 354
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Check Device Type",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1764708113376
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "metadata.ovenUpdate = \"true\"\nmetadata.method2 = \"setState\"\nreturn {msg:msg, metadata:metadata}",
          "tbelScript": "result = false\nif (metadata.device === \"LightsM\"){\n    result = true;\n}\nreturn result"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 645,
          "layoutY": 100
        }
      },
      {
        "type": "org.thingsboard.rule.engine.flow.TbRuleChainInputNode",
        "name": "To ABAC Rule Chain",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1764579326972
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "forwardMsgToDefaultRuleChain": false,
          "ruleChainId": "d25f9180-bab9-11f0-81ed-91764ceb7ef9"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 2392,
          "layoutY": 384
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbLogNode",
        "name": "Keycloak Logs",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);",
          "tbelScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1727,
          "layoutY": 598
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 3,
        "type": "Failure"
      },
      {
        "fromIndex": 0,
        "toIndex": 4,
        "type": "Success"
      },
      {
        "fromIndex": 0,
        "toIndex": 14,
        "type": "Success"
      },
      {
        "fromIndex": 1,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 2,
        "toIndex": 3,
        "type": "Failure"
      },
      {
        "fromIndex": 2,
        "toIndex": 6,
        "type": "Success"
      },
      {
        "fromIndex": 2,
        "toIndex": 14,
        "type": "Success"
      },
      {
        "fromIndex": 4,
        "toIndex": 2,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 3,
        "type": "Failure"
      },
      {
        "fromIndex": 5,
        "toIndex": 7,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 14,
        "type": "Success"
      },
      {
        "fromIndex": 6,
        "toIndex": 5,
        "type": "Success"
      },
      {
        "fromIndex": 7,
        "toIndex": 13,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 11,
        "type": "RPC Request to Device"
      },
      {
        "fromIndex": 8,
        "toIndex": 12,
        "type": "Attributes Updated"
      },
      {
        "fromIndex": 9,
        "toIndex": 10,
        "type": "Success"
      },
      {
        "fromIndex": 10,
        "toIndex": 1,
        "type": "Success"
      },
      {
        "fromIndex": 11,
        "toIndex": 9,
        "type": "True"
      },
      {
        "fromIndex": 11,
        "toIndex": 10,
        "type": "False"
      },
      {
        "fromIndex": 12,
        "toIndex": 9,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}